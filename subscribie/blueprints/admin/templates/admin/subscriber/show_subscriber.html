{% extends "admin/layout.html" %}
{% block title %} {{ title }} {% endblock %}

{% block body %}

<h2 class="text-center text-dark mb-3">Subscriber: {{ person.given_name }}</h2>

<div class="container">
  <ul class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">Shop</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}">Manage My Shop</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('admin.subscribers') }}">Subscribers</a></li>   
    <li class="breadcrumb-item active" aria-current="page"> {{ person.given_name }}</li>
  </ul>
</div>
      
<main>
  <div class="container">
      {# subscriber basic details #}
      <div class="row">
        <div class="card col-md-12">
          <div class="card-body">
            <h3 class="card-title">{{ person.given_name }} {{ person.family_name }}</h3>
          </div>
          <ul class="list-group list-group-flush">
            <li class="list-group-item">{{ person.email }}</li>
            <li class="list-group-item">{{ person.mobile }}</li>
            <li class="list-group-item"><strong>Address</strong>
              <address>
                {{ person.address_line1  }} <br />
                {{ person.city }} <br />
                {{ person.postal_code }}
              </address>
            </li>
          </ul>
          <a class="btn btn-success mb-4" title="Instantly charge your subscriber a one-off amount" href="{{ url_for('admin.charge_subscriber', person_id = person.id) }}">Charge Subscriber</a>
          <a class="btn btn-danger" href="{{ url_for('admin.archive_subscriber', subscriber_id = person.id) }}">Archive Subscriber</a>
          <br />
        </div>
      </div>
      {# end subscriber basic details #}
      <div class="row mt-5">
        <div class="card col-md-12">
          <div class="card-body">
            <h3>Subscriptions</h3>
          </div>
          <ul class="list-group list-group-flush">
            {% for subscription in person.subscriptions %}
              <li class="list-group-item">
                <strong>{{ subscription.plan.title }}</strong><br />
                <strong>Status:</strong> {{ subscription.stripe_status or 'Unknown' }} <br />
                <strong>Started: </strong> {{ subscription.created_at.strftime('%d-%m-%Y') }}<br />
                <strong>Interval Unit:</strong> 
                        {% if subscription.plan.requirements.subscription %}
                          {{ subscription.plan.interval_unit|capitalize }} 
                        {% else %}
                          (One-off. Not a subscription)
                        {% endif %}
                  <br />
                {% if subscription.plan.requirements.subscription %}
                  {% if subscription.stripe_status|lower == 'active' %}
                  <strong>Next date:</strong> {{ subscription.next_date().strftime('%d-%m-%Y') }} <br />
                  {% endif %}
                {% endif %}
                {% if subscription.chosen_options %}
                <strong>Choices:</strong>
                  
                  {% for chosen_option in subscription.chosen_options %}
                    <details open>
                      <summary>
                        {{ chosen_option.choice_group_title }}:
                      </summary>
                      {{ chosen_option.option_title }}
                    </details>
                  {% endfor %}

                {% endif %}

                <a href="{{ url_for('admin.transactions', subscriber=person.uuid) }}" title="View transactions">View Transactions</a>
                <br />
                <strong>Documents: </strong>
                {% if subscription.documents|length == 0 %}
                   None
                {% else %}
                  <ul>
                  {% for document in subscription.documents %}
                  {# Show documents assocated with subscription (if any) #}
                  <li><a href="{{ url_for('document.show_document', document_uuid=document.uuid) }}">
                      {{ document.name }}</a> | 
                      {{ document.created_at.strftime('%Y-%m-%d') }}</li>
                  {% endfor %}
                  </ul>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
          <!-- invoices list -->
          <div class="card-body">
            <h3>Invoices</h3>
            <div id="scroll-alert" class="alert alert-info" style="display:none;">
              <em>&lt;---- Swipe invoice table to the left to see all</em>
            </div>
            <style>
            #subscriber-invoices {
              border-collapse: collapse;
            }
            #subscriber-invoices tbody {
              display: block;
              overflow-x: scroll;
            }
            @media (max-width: 850px) {
              /* Scroll invoices table on mobile */
              #scroll-alert {
                display: block !important;
              }
              #subscriber-invoices tbody {
                max-width: 450px;
              }
            }
            @media (max-width: 400px) {
              #subscriber-invoices tbody {
                max-width: 265px;
              }
            }
            #subscriber-invoices th {
              padding: 8px;
            }
            #subscriber-invoices tr {
              border-bottom: 1px solid lightgray;
            }
            #subscriber-invoices td {
              text-align: center;
            }
            </style>
            <table id="subscriber-invoices">
            <tr>
              <th>Amount</th>
              <th>Status</th>
              <th>Charge Date</th>
              <th>Attempts</th>
              <th>Errors</th>
              <th>Next retry</th>
            </tr>
              {% for invoice in person.invoices() %}
              <tr>
                <td>{{ currencyFormat(invoice.currency, invoice.amount_due) }}</td>
                <td>{{ invoice.status }}</td>
                <td>{{ invoice.created | timestampToDate }}</td>
                <td>{{ invoice.attempt_count }}</td>
                <td>{{ invoice['stripe_decline_code'] or '' }}</td>
                {% if invoice.status == "open" %}
                <td>{{ invoice.next_payment_attempt | timestampToDate or 'Never'}}</td>
                {% else %}
                <td>{{ invoice.next_payment_attempt | timestampToDate or ''}}</td>
                {% endif %}
              </tr>
              {% endfor %}
            </table>
            <hr />
            <h4>Invoice heading explanations</h4>
            <dl>
                <dt>open</dt>
                <dd>The invoice has been finalised, and is awaiting customer payment.</dd>

                <dt>paid</dt>
                <dd>The invoice was paid.</dd>

                <dt>uncollectible</dt>
                <dd>The customer is unlikely to pay this invoice (treat it as bad debt in your accounting process).</dd>

                <dt>Attempts</dt>
                <dd>Number of payment attempts made for this invoice, from the perspective of the payment retry schedule. Any payment attempt counts as the first attempt, and subsequently only automatic retries increment the attempt count.</dd>

                <dt>Next Retry</dt>
                <dd>If a charge fails for a given invoice, and it can be retried, then "next retry" is the date when
                    another attempt to charge the subscriber will be made to collect that outstanding charge. Note
                    that new invoices will still be raised for a subscription if the subscription is still active.</dd>
            </dl>

            <details>
              <summary>When are failed payment attempts retried?</summary>
              <p>Using machine learning, Smart Retries chooses optimal times to retry failed payment attempts to increase the chance of successfully paying an invoice. The machine learning system behind Smart Retries uses hundreds of time-dependent, dynamic signals, such as:</p>
              <ul>
                <li>The number of different devices that have presented a given payment method in the last N hours.</li>
                <li>The optimal time to pay (payments made for debit cards in certain countries might be slightly more successful at 12:01 AM in local time zones).</li>
              </ul>
              <p>A payment retry will happen no more than 8 times within 3 weeks.</p>
            </details>


          </div>
          <!-- end invoices list -->
        </div>
      </div>

  </div><!--end container-->

</main>

{% endblock body %}
