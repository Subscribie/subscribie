{% extends "admin/layout.html" %}
{% block title %} {{ title }} {% endblock %}

{% block body %}

<h2 class="text-center text-dark mb-3">Subscriber: {{ person.given_name }}</h2>

<div class="container">
  <ul class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">Shop</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}">Manage My Shop</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('admin.subscribers') }}">Subscribers</a></li>   
    <li class="breadcrumb-item active" aria-current="page"> {{ person.given_name }}</li>
  </ul>
</div>
      
<main>
  <div class="container">
      <div class="row">
        <div class="card col-md-4" style="width: 18rem;">
          <div class="card-body">
            <h3 class="card-title">{{ person.given_name }} {{ person.family_name }}</h3>
          </div>
          <ul class="list-group list-group-flush">
            <li class="list-group-item">{{ person.email }}</li>
            <li class="list-group-item">{{ person.mobile }}</li>
            <li class="list-group-item"><strong>Address</strong>
              <address>
                {{ person.address_line1  }} <br />
                {{ person.city }} <br />
                {{ person.postal_code }}
              </address>
            </li>
          </ul>
          <a class="btn btn-success mb-4" title="Instantly charge your subscriber a one-off amount" href="{{ url_for('admin.charge_subscriber', person_id = person.id) }}">Charge Subscriber</a>
          <a class="btn btn-danger" href="{{ url_for('admin.archive_subscriber', subscriber_id = person.id) }}">Archive Subscriber</a>
          <br />
        </div>

        <div class="col-md-1"></div>

        <div class="card col-md-7" style="width: 18rem;">
          <div class="card-body">
            <h3>Subscriptions</h3>
          </div>
          <ul class="list-group list-group-flush">
            {% for subscription in person.subscriptions %}
              <li class="list-group-item">
                <strong>{{ subscription.plan.title }}</strong><br />
                <strong>Status:</strong> {{ subscription.stripe_status or 'Unknown' }} <br />
                <strong>Started: </strong> {{ subscription.created_at.strftime('%d-%m-%Y') }}<br />
                <strong>Interval Unit:</strong> 
                        {% if subscription.plan.requirements.subscription %}
                          {{ subscription.plan.interval_unit|capitalize }} 
                        {% else %}
                          (One-off. Not a subscription)
                        {% endif %}
                  <br />
                {% if subscription.plan.requirements.subscription %}
                  {% if subscription.stripe_status|lower == 'active' %}
                  <strong>Next date:</strong> {{ subscription.next_date().strftime('%d-%m-%Y') }} <br />
                  {% endif %}
                {% endif %}
                {% if subscription.chosen_options %}
                <strong>Choices:</strong>
                  
                  {% for chosen_option in subscription.chosen_options %}
                    <details open>
                      <summary>
                        {{ chosen_option.choice_group_title }}:
                      </summary>
                      {{ chosen_option.option_title }}
                    </details>
                  {% endfor %}

                {% endif %}

                <a href="{{ url_for('admin.transactions', subscriber=person.uuid) }}" title="View transactions">View Transactions</a>
              </li>
            {% endfor %}
          </ul>
          <!-- invoices list -->
          <div class="card-body">
            <h3>Invoices</h3>
            <style>
            #subscriber-invoices th {
              padding: 8px;
            }
            #subscriber-invoices td {
              text-align: center;
            }
            </style>
            <table id="subscriber-invoices">
            <tr>
              <th>Amount</th>
              <th>Status</th>
              <th>Created</th>
              <th>Payment Attempts</th>
            </tr>
              <tbody>
              {% for invoice in person.invoices() %}
              <tr>
                <td>{{ invoice['total'] | currencyFormat }}</td>
                <td>{{ invoice['status'] }}</td>
                <td>{{ invoice['created']| timestampToDate }}</td>
                <td>{{ invoice['attempt_count'] }}</td>
              </tr>
              {% endfor %}
              </tbody>
            </table>
            <hr />
            <h4>Invoice heading explanations</h4>
            <dl>
                <dt>open</dt>
                <dd>The invoice has been finalised, and is awaiting customer payment.</dd>

                <dt>paid</dt>
                <dd>The invoice was paid.</dd>

                <dt>uncollectible</dt>
                <dd>The customer is unlikely to pay this invoice (treat it as bad debt in your accounting process).</dd>

                <dt>Payment attempts</dt>
                <dd>Number of payment attempts made for this invoice, from the perspective of the payment retry schedule. Any payment attempt counts as the first attempt, and subsequently only automatic retries increment the attempt count.</dd>
            </dl>
          </div>
          <!-- end invoices list -->
        </div>
      </div>

  </div><!--end container-->

</main>

{% endblock body %}
