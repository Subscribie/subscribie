{% extends "admin/layout.html" %}                                                
{% from 'macros/plan_assign_managers_form.html' import plan_assign_managers_form %}
{% block title %} Subscribers {% endblock %}                                
                                                                                 
{% block body %}

<h2 class="text-center text-dark mb-3">My Subscribers</h2>

<div class="container">
  <ul class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">Shop</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}">Manage My Shop</a></li>   
    <li class="breadcrumb-item active" aria-current="page">Subscribers</li>
  </ul>
</div>
<main>
  <div class="section">
    <div class="container">
      <div class="mb-4">
         <a href="{{url_for('admin.subscribers')}}" id="show-active-subscribers" class="btn btn-primary">Show all</a>
         <a href="{{url_for('admin.subscribers', action='show_active')}}" id="show-active-subscribers" class="btn btn-primary ">Show all Active</a>
      {% if settings.donations_enabled %}
          {% if action == "show_donors" %}
              <a href="{{url_for('admin.subscribers')}}" id="show-active-subscribers" class="btn btn-primary">Show all</a>
          {% else %} 
              <a href="{{url_for('admin.subscribers', action='show_donors')}}" id="show-donors" class="btn btn-primary ">Show Donors</a>
          {% endif %}
      {% endif %}
      <a href="{{ url_for('admin.subscribers', action='show_plans_i_manage') }}" id="show-plans-I-manage" class="btn btn-primary">Show only Subscribers with plans I manage</a>
      <button id="refresh_subscriptions" title="Get latest subscription statuses (active/paused/inactive)" class="btn btn-primary disable-on-click">Refresh Subscriptions</button>
       </div>
        <form action="#" method="GET">
        <h4>Search...</h4>
        {% if show_plans_i_manage %}
          <div class="alert alert-warning">
            <p>Showing only subscribers with plans you are a manager of.</p>
          </div>
        {% endif %}

        {% if user.plans | length == 0 and settings.feature_can_assign_users_to_plans %}
        <div class="alert alert-warning">
          You don't currently have any plans assigned to your user. To assign plans to your user login,
          <a href="{{ url_for('admin.edit') }}">Edit an existing plan</a> or <a href="{{ url_for('admin.add_plan') }}">Create a new plan</a> and click 'Managers' when editing or adding
          a plan to assign manager(s).
        </div>
        {% endif %}
        {% if request.args.get("subscriber_email") or request.args.get("subscriber_name") %}
        <div class="alert alert-warning">
          You currently have a search filter active. <a href="{{ url_for('admin.subscribers') }}">Click here to show all subscribers again</a>.
        </div>
        {% endif %}
        <div class="form-group">
          <label for="subscriber_name">Subscriber name:</label>
          <input type="text" name="subscriber_name" id="subscriber_name" class="form-control mb-2" placeholder="Enter subscriber's name..." value="{{ request.args.get("subscriber_name") or '' }}" />
          <label for="plan_title">Subscriber email:</label>
          <input type="text" name="subscriber_email" id="subscriber_email" class="form-control" placeholder="Enter subscriber's email..." value="{{ request.args.get("subscriber_email") or '' }}" />
          <input type="submit" class="btn btn-primary mt-4" />
        </div>
        </form>
      <table class="table mobile-optimised">
        <thead>
          <tr>
            <th>Name</th>
            <th>Date</th>
            <th>Contacts</th>
            <th>Address</th>
            <th>Plan</th>
          </tr>
        </thead>
        <tbody>
        {% for person in people %}
          <tr>
            <td data-th="Name">
              <a href="{{ url_for('admin.show_subscriber', subscriber_id=person.id) }}">{{ person.given_name }} {{ person.family_name }}</a>
              <br />
            </td>
            <td data-th="Date">{% if person.created_at %} 
              {{ person.created_at.strftime('%Y-%m-%d') }}
            {% endif %}</td>
            <td data-th="Contact"><strong>Email: </strong>
                <a href="mailto:{{ person.email }}" class="subscriber-email">{{ person.email }}</a><br>
                <strong>Phone: </strong><a href="tel:{{ person.mobile }}">
                {% if person.mobile and person.mobile != "NULL" %}
                    {{ person.mobile }}</a><br>
                {% endif %}
            </td>
            <td data-th="Address"><address>
              {{ person.address_line1 }}<br />
              {{ person.city }} <br />
              {{ person.postal_code }} <br />
            </address></td>
            <td data-th="Plan">
              {% if person.subscriptions and action != "show_donors" %}
              <ul class="list-unstyled">
                {% for subscription in person.subscriptions %}
                    <li>
                        <div class="card">
                            {% if subscription.plan.users| length == 0 %}
                              <div class="alert alert-warning">
                                <h5>Assign a manager</h5>
                                No manager(s) are assigned to this plan.
                                {{ plan_assign_managers_form(subscription.plan, users) }}
                              </div>
                            {% endif %}
                            <ul class="list-unstyled px-2">
                                <li><strong>Title: </strong>
                                    <span class="subscription-title">{{ subscription.plan.title }}</span>
                                </li>
                                <li>
                                  <strong>Interval:</strong>
                                  {% if subscription.plan is not sameas None and subscription.plan.interval_unit is not sameas None %}
                                    {{ subscription.plan.interval_unit.capitalize() }}
                                  {% else %}
                                    {{ subscription.plan.interval_unit }}
                                  {% endif %}
                                </li>
                                {% if subscription.chosen_options %}
                                    <li>
                                        <details open>
                                            <summary><strong>Chosen Options</strong></summary>
                                            <ul>
                                                {% for choice in subscription.chosen_options %}
                                                    <li><strong>{{ choice.choice_group_title }}:</strong> {{ choice.option_title }}</li>
                                                {% endfor %}
                                            </ul>
                                        </details>
                                    </li>
                                {% endif %}
                                <li><strong>Subscription ID: </strong>{{ subscription.uuid }}</li>
                                <li><strong>Date started: </strong>{{ subscription.created_at.strftime('%d-%m-%Y') }}</li>
                                <li>
                                    {% if subscription.plan.requirements and subscription.plan.requirements.subscription %}
                                        <strong>Price: </strong>
                                        <span class="subscribers-plan-interval_amount">{{ subscription.showIntervalAmount() }}</span>
                                    {% else %}
                                        (One-off. Not a subscription)
                                    {% endif %}
                                </li>
                                <li><strong>Sell price: </strong>
                                    <span class="subscribers-plan-sell-price">
                                        {% if subscription.plan.requirements and subscription.plan.requirements.instant_payment %}
                                            {{ subscription.showSellPrice() }}</li>
                            {% else %}
                                (No up-front fee)
                            {% endif %}
                                    </span>
                                    <li><strong>Status:</strong>
                                        {% if subscription.plan.requirements and subscription.plan.requirements.subscription %}
                                           {% if subscription.stripe_pause_collection == "void" %}
                                              <div class="subscription-status alert alert-warning">Paused</div>
                                           {% elif subscription.stripe_status == "canceled" %}
                                              <div class="subscription-status alert alert-secondary">Canceled</div>
                                           {% elif subscription.stripe_status == 'active'  %}
                                              <div class="subscription-status alert alert-success">Active</div>
                                           {% elif subscription.stripe_status == 'past_due'  %}
                                              <div class="subscription-status alert alert-danger">past_due</div>
                                           {% else %}
                                              <div class="subscription-status alert alert-dark">{{ subscription.stripe_status }}</div>
                                           {% endif %}
                                        {% else %}
                                           <div class="subscription-status alert alert-success">Paid</div>
                                        {% endif %}
                                    </li>
                                    {% if subscription.stripe_status == 'canceled' %}
                                    <li>
                                      <strong>Date ended at:</strong> {{ subscription.stripe_ended_at | timestampToDate }}
                                    </li>
                                    {% endif %}
                                    {% if subscription.stripe_cancel_at %}
                                      <strong>Automatically Cancels at:</strong>
                                      {{ subscription.stripe_cancel_at | timestampToDate }}
                                    {% endif %}
                                    <li>
                                    </li>
                                    <li>
                                        {% if subscription.plan.requirements and subscription.plan.requirements.note_to_seller_required %}
                                            <details open>
                                                <summary><strong>Order Note</strong></summary>
                                                {% if subscription.note %}
                                                    {{ subscription.note.note }}
                                                {% else %}
                                                    No note was given.
                                                {% endif %}
                                            </details>
                                        {% endif %}
                                    </li>
                                    <li><strong>Actions: </strong>
                                        {% if subscription.plan.requirements and subscription.plan.requirements.subscription %}
                                            {% if subscription.stripe_status|lower in ['active', 'trialing', 'past_due', 'unpaid'] %}
                                                {% if subscription.stripe_status|lower != 'trialing' and subscription.stripe_pause_collection != 'void' %}
                                                <a href="{{ url_for("admin.pause_stripe_subscription",
                                                subscription_id=subscription.stripe_subscription_id,
                                                confirm="") }}">
                                                    <span class="pause-action">Pause</span>
                                                </a> |
                                                <a href="{{ url_for("admin.cancel_stripe_subscription",
                                                subscription_id=subscription.stripe_subscription_id,
                                                confirm="") }}">
                                                    <span class="cancel-action">Cancel</span>
                                                </a> |
                                                {% endif %}
                                            {% endif %}
                                            {% if subscription.stripe_pause_collection|lower == 'void' %}
                                                <a href="{{ url_for("admin.resume_stripe_subscription",
                                                subscription_id=subscription.stripe_subscription_id,
                                                confirm="") }}">
                                                    <span class="resume-action">Resume</span>
                                                </a> |
                                                <a href="{{ url_for("admin.cancel_stripe_subscription",
                                                subscription_id=subscription.stripe_subscription_id,
                                                confirm="") }}">
                                                    <span class="cancel-action">Cancel</span>
                                                </a> |
                                            {% endif %}
                                        {% endif %}</li>
                                     <li class=mt-2><strong>History: </strong>
                                      <a href="{{ url_for('admin.transactions',
                                        subscriber=subscription.person.uuid) }}">View Transactions
                                      </a>
                                     </li>
                                     <li class=mt-2><strong>Documents: </strong>
                                       {% if subscription.documents|length == 0 %}
                                          None
                                       {% else %}
                                         <ul>
                                         {% for document in subscription.documents %}
                                         {# Show documents assocated with subscription (if any) #}
                                         <li><a href="{{ url_for('document.show_document', document_uuid=document.uuid) }}">
                                             {{ document.name }}</a> | 
                                             {{ document.created_at.strftime('%Y-%m-%d') }}</li>
                                         {% endfor %}
                                         </ul>
                                       {% endif %}
                                     </li>
                                     {% if subscription.plan.users | length > 0 %}
                                     <li class="mt-2" style="padding: 0.75rem 1.25rem;"><strong>Manager(s):</strong>
                                       {{ plan_assign_managers_form(subscription.plan, users) }}
                                     </li>
                                     {% endif %}


                            </ul>
                        </div>
                    </li>
                {% endfor %}
              </ul>
                {% elif person.transactions %}
                {# Donations are not in the subscription table since they are not plans nor subscriptions #}
                {# therefore we need to look at the transction table to find the donations #}
                {% for transaction in person.transactions %}
                    {% if transaction.is_donation %}
                        <div class="card">
                            <ul class="list-unstyled px-2">
                                <li><strong>Title: </strong>
                                    <span class="donation-title">Donation</span>
                                </li>
                                <li><strong>Transaction ID: </strong>{{ transaction.uuid }}</li>
                                <li><strong>Date: </strong>{{ transaction.created_at.strftime('%Y-%m-%d') }}</li>
                                <li>
                                        <strong>Price: </strong>
                                        <span class="donation_amount">{{ transaction.showSellPrice() }}</span>
                                </li>
                                    </span>
                                    <li><strong>Status:</strong>
                                              <span class="transaction-status">{{ transaction.payment_status }}</span>
                                    </li>
                                    <li>
                                        {% if transaction.comment %}
                                            <details open>
                                                <summary><strong>Donation Note</strong></summary>
                                                    {{ transaction.comment }}
                                        {% else %}
                                                    No note was given.
                                            </details>
                                        {% endif %}
                                    </li>
                            </ul>
                        </div>
                    {% endif %}
                {% endfor %}
                {% else %}
                    <div class="card">
                    <ul class="list-unstyled px-2">
                    <li><strong>{{ _('Notice:') }}</strong>
                      <p>{{ _('There may be a delay in processing a recent transaction,
                        please check back later or') }} <br />
                        <a href="{{ url_for('admin.refresh_subscriptions') }}"
                        class="btn btn-success btn-sm mt-4">{{ _('Refresh subscriptions now') }}</a>
                    </li>
                    </ul>
                    </div>
                {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div> <!-- end .container -->
  </div><!-- end .section -->
</main>

<script>
{# give UI feedback whilst waiting for active subscribers to load #}
document.getElementById('refresh_subscriptions').addEventListener('click', function(e) {
  e.target.textContent = "Please wait...";
});

{# Refresh subscription statuses when button clicked #}
btnRefreshSubscriptions = document.getElementById('refresh_subscriptions');

btnRefreshSubscriptions.addEventListener('click', refreshSubscriptionStatuses);

function refreshSubscriptionStatuses() {
  fetch("{{ url_for('admin.refresh_subscriptions') }}")
  .then(response => { document.location = "{{ url_for('admin.refresh_subscriptions') }}" });
}
{# End Refresh subscription statuses when button clicked #}

</script>

{% endblock body %} 
